# S3(Simple Storage Service)

* 스마트한 객체 스토리지 서비스로 데이터를 객체 단위로 관리.
* 인터넷상에 데이터를 저장하는 장소를 제공.
* 용량 제한 없음.
* 기능이 많으며 대표적으로 웹 서버 기능, 쿼리 기능이 있음.
    * 간단하게 웹 서버 구축, 쿼리를 이용해 집계 가능.
* 클라우드이기 때문에 확장 축소 쉬움.

## S3 특징

### 1. 확장성

* 사용 목적에 맞게 다양한 스토리지 클래스가 있음.
* 수명 주기 정책을 통해 자동으로 이동 가능.

### 2. 가용성, 내구성

* 99.999999999%의 데이터 내구성을 가지고 있어 장애, 오류, 위협에 강함.
* S3 객체는 최소 4개의 가용 영역에 자동으로 복제되어 보존.

### 3. 신뢰성

* 암호화 기능과 접근 관리 도구가 있어 보안이 좋음.
* 각종 규정을 준수하며 감사 기능을 갖춤.

### 4. 다양한 관리 기능

* 스토리지 클래스 분석, 수명 주기 정책 등 각종 관리 기능이 있음.
* 관리 기능을 사용하면 실제 사용 환경에 맞는 스토리지 클래스 선택 가능.

### 5. 스마트한 기능

* S3 Select라는 데이터에 쿼리를 실행하는 기능과 서비스 존재.
* Althena, Redshift Spectrum 등의 분석 서비스와 호환.
* Lambda와 연동 가능.

## 요금 체계

* 스토리지 클래스(스토리지의 종류)와 리전에 따라 다름.
* 기본적으로 보유하고 있는 용량과 전송량을 기준으로 종량 과금. (저장 용량 + 전송량)
* 저장 용량
    * 일할(일단위 나눔)하여 계산, 30/90/180일 단위로 계산하는 경우 등 방식 다양.
    * 최소 용량 요금이 설정되는 경우도 있음.
* 전송량
    * S3에서 파일을 받거나 보낼 때 발생하는 요금.
    * 수신 요청(GET)이나 송신 요청(PUT)에 대해 1GB 단위로 과금. 
        * 수신 요청 : 파일 다운로드, 페이지 요청
        * 송신 요청 : 파일 업로드

<br/>

# 스토리지 클래스

* 스토리지의 종류로 액세스 패턴에 따라 다양.
* 버킷(객체를 저장하는 컨테이너) 단위가 아닌 객체(파일) 단위로 클래스 선택 가능.
* 상황에 따라 변경 가능.
    * 수명 주기 정책으로 자동 수행 가능.

## 스토리지 클래스 종류

### 1. Standard

* 3곳 이상의 AZ에 데이터가 저장되어 99.99% 가용성 보장.
* 데이터 검색 요금과 최소 용량 요금 없음.
* 일할 계산되므로 쉽게 사용하기 좋은 클래스.

### 2. Intelligent-Tiering

* 빈번한 액세스와 간헐적 액세스 계층 존재.
* 어디에 저장할지는 객체별로 모니터링하여 결과에 따라 자동으로 이동.
    * 30일간 연속으로 액세스 없으면 간헐적 액세스 계층, 늘어나면 빈번한 액세스 계층으로 이동.
* 액세스 빈도가 자주 바뀔시 유용.
* 검색 요금, 액세스 계층간 이동 요금 없음.
* 최소 저장 기간에 대한 요금이 있음.

### 3. Infrequent Access

* Standard에 비해 저장 요금이 낮지만 액세스 요금이 높음.
* 액세스 빈도가 낮고 용량이 큰 데이터에 적합.
* Standard - Infrequent Access : 최소 세 개 이상의 AZ에 저장.
* One Zone - Infrequent Access : 한 곳의 AZ에 저장.
    * 해당 지역에 물리적인 문제 발생시 데이터 유실 가능.

### 4. Reduced Redundancy Storage(RSS)

* Standard에 비해 이중화 수준을 낮춰 낮은 가격을 제공.
* 저장되는 AZ가 한 군데이므로 데이터 유실 가능성 존재.
* Standard의 옵션격인 클래스.

### 5. S3 Glacier/S3 Glacier Deep Archive

* 데이터 아카이브와 장기간 백업을 고려한 클래스.
* 내구성이 좋고 가격이 낮아 대용량 데이터를 저렴한 가격에 보관 가능.
* 데이터는 볼트라고 하는 컨테이너에 저장.
* 저장된 데이터를 읽는 경우 다른 S3 버킷으로 옮겨야 하는 작업이 필요.
* 검색시 Glacier상의 데이터와 검색 대상의 데이터 양쪽에 요금이 부과됨.

<br/>

# S3 사용

* S3는 파일을 버킷에 저장하며 파일을 객체라고 명명.
* 객체는 버킷, 객체 키, 버전으로 관리.

## 조작

* 버킷 생성, 각종 설정, 업로드 등 관리 콘솔에서 조작.
* API와 SDK를 통한 조작 방식도 지원.
* AWS Transfer foe SFTP가 제공되어 SFTP로 액세스 가능.

## 용어

|항목|내용|
|---|---|
|객체|S3의 엔티티 단위로 텍스트나 이미지 등의 파일.|
|버킷|객체를 저장하는 컨테이너로 모든 객체는 버킷에 저장.|
|버킷명|버킷의 명칭은 유일해야 함.<br/>웹 서버로 사용시 도메인명으로 사용.|
|객체 키|객체 식별자.<br/>버킷, 객체 키, 버전을 조합해서 객체 식별.|
|객체 메타데이터|이름과 값의 세트로 객체를 업로드할 떄 설정 가능.<br/>사람이 파일을 쉽게 관리하기 위한 데이터.<br/>객체 키는 S3가 파일을 식별하기 위해 사용.|
|리전|버킷의 물리적인 보관 장소가 있는 지역.|
|Amazon S3의 데이터 일관성 모델|가용성을 위해 데이터 자동 복제/저장하지만 쓰기 지연으로 인한 데이터 불일치 방지를 위해 데이터 무결성 보장.<br/>복제가 모두 반영 될때까지 시간 다소 걸릴 수 있음.|
|버전 관리|여러 버전을 보관.<br/>다른 버전은 별도의 객체로 취급 가능.|
|로그|버킷이나 객체 단위로 로그 기록 가능.<br/>객체의 경우 유료.|
|암호화|데이터를 자동으로 암호화.|
|액세스 제어|버킷에 대한 권한 설정.|
|웹 서비스|버킷을 웹 사이트로 사용 가능.|

## 사용 절차

### 1. AWS에 로그인

* 리전 선택, 관리 콘솔 오픈.
* S3 대시보드 오픈.

### 2. 버킷 생성

* 버킷명 설정.

### 3. 버킷 설정

* 웹 서버로 사용할 경우 Static website hosting 설정.
* 접근할 수 있는 사용자 설정.

### 4. 파일 업로드

* 관리 콘솔이나 전용 도구에서 파일 업로드.

## 버킷 생성 전 검토 사항

* 버킷을 생성한 후에는 이름과 리전 변경 불가.
* 웹 서버로 사용할지 파일 서버나 로그 저장소로 사용할지 고려 필요.
* 웹 서버로 사용 시 버킷에 대한 공개, 도메인, 익명 접속 허가 등 고려.
    * 소유한 도메인을 사용할 시 버킷명을 도메인명과 동일하게 세팅.
    * 테스트용 버킷 생성 및 확인을 먼저 진행하면 좋음.
* 파일 서버는 사용법에 맞게 도구나 SFTP 등 준비.
* 로그 저장소는 접속 대상과 인증 방법 고려.

<br/>

# 객체와 버킷

* 버킷은 윈도의 드라이브, 객체는 파일과 같은 것.
* 버킷은 폴더가 아니므로 버킷 안에 버킷 생성 불가.
* 버킷은 AWS 계정 하나당 100개 생성 가능.
    * 별도 신청시 1,000개.
* 객체는 단순 파일이 아닌 관리를 위한 메티데이터를 포함.
    * 생성일시, 크기 등.
* 버킷에 저장 가능한 객체 수나 용량에 제한이 없음.
* 객체는 버킷에 계층 구조가 아닌 병렬로 배치.
    * 폴더나 디렉토리 개념 없음.
    * 편의를 위해 관리 콘솔에서는 폴더로 표시됨.

## 버킷 생성

* 버킷 생성 시 리전과 버킷명 변경 불가.
* 버킷명은 S3 안에서 유일해야 함.
    * 다른 사용자가 쓰고있는 버킷명 생성 불가.
    * 리전을 변경해도 같은 버킷명 생성 불가.

## 버킷 명명 규칙

```
버킷명 예시 : gihyo.bucket.marvelous.sample
```

* 버킷명은 처음과 끝에 알파벳이나 숫자 사용.
* 3글자 이상 63글자 이하.
* DNS 명명 규칙에 따라야 함.
    * IP 주소형식 사용 불가.
    * 대문자나 언더스코어 사용 불가.

<br/>

# 액세스 제한

## 버킷에 대한 엑세스 제한 설정방법 3가지

1. 버킷 단위로 제한하는 버킷 정책
    * 해당 버킷에 접속할 수 있는 사용자를 지정.
    * 사용자가 많을 시 지정.
1. IAM 사용자 단위로 제한하는 사용자 정책
    * 접속 가능한 버킷을 지정.
    * 버킷이 많을 시 지정.
1. ACL(액세스 제어 목록)에 의한 관리 정책
    * 자신 외의 다른 AWS 계정의 읽기/쓰기에 대해 허가/거부 설정 목록

## 액세스 제한의 대상과 내용

* 누가, 무엇을, 어떤 것에 대해 가능한지 여부를 정함.

|항목|내용|
|---|---|
|리소스|제한 대상이 되는 버킷 및 객체.<br/>아마존 리소스 이름 사용해서 식별.|
|작업|실제로 가능한 작업.<br/>GET, PUT, DELETE.|
|효과|설정 여부.<br/>허가(allouw), 거부(deny) 설정.|
|보안 주체|허가나 거부할 사용자 및 계정, 서비스.|

<br/>

# 웹 사이트 호스팅

* S3는 정적 웹 사이트 호스팅이 가능.
    * 정적 웹 사이트
        * 서버가 스크립트를 처리하지 않는 사이트.
        * 단순한 HTML, 이미지만으로 작성됨.
    * 동적 웹 사이트
        * PHP, JSP 등 서버에서 처리하는 언어가 포함됨.

## 필요한 설정

* 정적 웹 호스팅을 활성화.
* 공용 액세스(public access) 차단 해제.
    * 파일에 누구든지 접근 가능하기 때문에 보안 주의.
* 버킷 정책을 '모든 사용자'로 활성화.
* 버킷명을 사용할 도메인명으로 지정.
* 개인 도메인은 Amazon Route 53 등의 DNS 서비스 설정.

## 다른 서비스로 구축한 웹 호스팅과 차이

* EC2 외에 Lightsail, AWS Amplify가 있으며, 큰 차이는 서버 프로그램 실행 여부와 확장성.

### Amazon Lightsail

* EC2를 단순화한 서비스.
* 필요한 기능을 선택하면 웹 사이트에 필요한 서비스 전체를 정해진 가격으로 구축. (패키지화)
* 요금도 각 서비스별로 나눠지지 않고 Lightsail 하나만 계산하면되서 편리.
* CPU, 메모리같은 사양이나 대수에 대한 유연성 없음.
    * 변경시에 스냅샷으로 백업하고 서비스 세팅후 복원하는 작업 필요.

### AWS Amplify

* 모바일 앱이나 웹 앱을 개발하기 위한 프레임워크 제공.
* 자바스크립트로 AWS의 다양한 기능을 호출하여 시스템 구축.
* HTML, 이미지는 S3로 배포하고 Lambda로 백엔드 프로그램 실행하는 식으로 서비스를 조합.

### 각 서비스 비교

|서비스|서버 프로그램 실행|확장성|
|---|---|---|
|EC2|◎|△|
|S3|X|◎|
|Lightsail|◎|△|
|Amplify|○(Amplify 독자적 프로그램)|○|

<br/>

# 파일 업로드, 다운로드

* 관리 콘솔과 CLI, 도구 및 프로그램에서는 API나 SDK를 사용.
* 모든 파일 형식이 가능하며, 파일 크기에는 제한이 있음.
    * 관리 콘솔의 경우 160GB(2021년 3월 기준).
    * 160GB 이상은 CLI나 SDK 사용.

## 다양한 업로드 방법

### 1. API와 SDK

* 서드 파티 도구로 업로드 가능.
* IAM 사용자에게 액세스 키와 보안 액세스 키를 발행하여 사용하고 싶은 도구에 설정.

### 2. 멀티 파트 업로드

* 객체를 여러 개로 나누어 세트 하나로 업로드.
* 업로드 중에는 부분별로 표시, 완료되면 객체 하나가 됨.
* 실패한 부분은 재전송, 일시정지도 가능.
    * 일시정지는 종료 기간이 없음.
* 100MB 이상은 멀티 파트 업로드를 사용하는 것을 추천.
    * 멀티 파트 업로드 자체는 요금이 따로 발생하지 않음.
* 관리 콘솔, CLI는 큰 파일 업로드 시 멀티 파트로 전환됨.

### 3. AWS Transfer for SFTP

* SFTP 도구가 아닌 SFTP 서버를 제공하는 서비스.
* SFTP 서버 엔드포인트 설정 시, 서드 파티의 SFTP 도구 사용 가능.
* 초기 비용은 없지만 SFTP 서버 사용시간과 데이터 전송량에 대해 과금.

### 4. AWS DataSync

* 온프레미스 스토리지 시스템과 AWS 스토리지 서비스(EC2, S3) 간에 대용량 데이터 전송 서비스.
* 요금은 복사하는 데이터양에 따라 발생.
* S3버킷을 온프레미스처럼 사용하는 하이브리드 클라우드 스토리지 서비스(AWS Storage Gateway)도 존재.

<br/>

# 액세스 관리 및 변조 방지 (부정한 액세스 감시)

## 액세스 로그

* 서버에 어떤 요청이 있었는지 기록하는 기능.
* 로그 기록에 대한 요금이 부과되지 않음.
* 로그를 기록한 파일은 버킷에 보관되므로 보관에 대한 요금 발생.

#### ※ 주요 로그 내용

|항목|내용|
|---|---|
|원격 IP|요청자의 IP 주소|
|요청자|액세스한 사용자|
|요청 ID|요청 식별을 위한 S3가 생성한 ID|
|작업|요청된 작업 종류|
|키|요청된 객체 키|
|요청 URL|요청된 URI|
|오류 코드|오류 코드(있는 경우만)|
|보낸 바이트|송신된 응답 바이트 수|
|객체 크기|요청된 객체의 전체 크기|
|총 시간|요청이 수신된 시간부터 응답의 마지막 바이트 전송까지 걸린 시간|
|반환 시간|요청의 마지막 바이트가 수신된 시간부터 응답의 첫 바이트 전송까지 걸린 시간|
|Referrer|HTTP Referrer 헤더 값|
|사용자 에이전트|HTTP User-Agent 헤더 값|
|버전 ID|요청의 버전 ID|
|호스트 헤더|S3 접속에 사용하는 엔드포인트|

## 스토리지 클래스 분석

* 객체에 액세스 빈도를 분석하는 기능.
* 빈도가 낮을때 S3 Intelligent-Tiering로 이동하는 판단 자료로 사용.
* 객체는 설정된 날짜별로 그룹화되어서 각 그룹의 평균 전송 바이트 수 감시.
* 대상 객체 필터링해서 감시 가능.
    * 필터는 버킷당 1,000개까지 설정 가능.

## 객체 잠금

* 객체를 보호하는 기능.
* 객체 삭제, 덮어쓰기, 변조 등 방지.
* 잠금 기능은 유효 기간이 존재, 법적으로 보존해야 하는 경우 유효 기간 없음.
* 잠금으로 보호되는 버킷은 CRR(Cross-Region Replication)로 복사 불가.

#### ※ 객체 잠금 두 가지 보관 모드

|보관 모드|내용|
|---|---|
|거버넌스 모드|특정 사용자에게만 객체 변경 허가.|
|규정 준수 모드|모든 사용자가 객체 변경 불가(root 계정 포함).|

## S3 인벤토리

* 객체의 메타데이터의 목록을 매일 또는 매주 생성하는 기능.
* CSV, ORC 등의 파일.
* 빅데이터를 처리하는 도구와 조합하면 편리.
    * Amazon Athena, Amazon Redshift Spectrum.

## S3 배치 작업

* 대상 객체에 대한 객체 복사, 복원 등 여러 작업 실행.
* 배치 작업은 보통 S3 API를 사용해서 편리.

