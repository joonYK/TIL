# Amazon VPC(Virtual Private Cloud)

* AWS 계정 전용 가상 네트워크 서비스.
    * 네트워크와 서브넷 범위, 라우팅 테이블, 네트워크 게이트웨이 등 가상 네트워킹 환경 설정.
* AWS에서 제공하는 리소스만 설치 가능.
* EC2나 RDS의 경우 VPC 없이는 서버 생성 불가.

## VPC의 구성

* VPC 내에 서버를 설치하면 해당 네트워크에 소속됨.
* 별도 설정 없으면 VPC 자체는 격리된 네트워크가 됨.
* 외부와의 통신은 인터넷이나 회사 내 LAN과 연결 필요.

## 기능

* 가상 환경이기 때문에 물리적인 네트워크와 다른 점도 있지만 기본 개념은 같음.
* IPv4, IPv6 둘 다 사용 가능.

#### ※ 주요 기능

|항목|내용|
|---|---|
|CIDR 블록|서브넷이며 네트워크를 나눈 범위.<br/>VPC 생성시 네트워크 범위를 CIDR로 정하고 더 작은 서브넷으로 나눔.|
|서브넷 마스크|네트워크의 크기를 계산하는 값.<br/>CIDR은 서브넷 마스크의 표기법 중 하나.|
|가용 영역|서브넷이 구축된 물리적 장소.|
|인터넷 게이트웨이|인터넷 접속 출입구.<br/>VPC를 인터넷에 연결하지 않으면 불필요.|
|라우팅|어떤 데이터를 어디에 보낼지 조정.<Br/>게이트웨이와 라우팅으로 송수신 설정을 해야 VPC가 인터넷 접속 가능.<br/>|
|라우팅 테이블|라우팅에 대한 설정이 기록된 테이블.|
|보안 그룹|AWS가 제공하는 가상 방화벽.<br/>인스턴스 단위로 설정, 유입되는 데이터는 '거부'가 기본 설정.|
|네트워크 ACL|AWS가 제공하는 가상 방화벽으로 서브넷 단위로 설정.|

## VPC 네트워크의 특징과 라우팅 테이블

* VPC와 네트워크와 일반 네트워크의 큰 차이점은 라우터.
* VPC는 소프트웨어가 라우터 역할을 수행.
    * 라우팅 테이블 하나에 서브넷 여러 개를 설정 가능.
* 물리 서버는 LAN 케이블과 와이파이로 라우터와 연결, 클라우드는 라우팅 테이블로 연결.
* 일반적인 서브넷 사이의 통신은 라우터로 하지만, VPC의 경우는 라우터 없이 통신 가능.
* VPC 하나에 인터넷 게이트웨이 한 개만 설정 가능.
* 라우터와 인터넷 게이트웨이는 명시적인 IP 주소 부여 없음.

<br/>

# 사용

## 설정을 위해 꼭 필요한 확인 사항

### 1. 인터넷 연결 여부

* 인터넷 연결이 필요하면 인터넷 게이트웨이 설정 필요.

### 2. 오토 스케일링

* 서버가 자동으로 늘어나기 때문에 IP 주소를 많이 확보해야 함.

### 3. 보안 그룹과 네트워크 ACL

* 인스턴스 용도에 맞는 포트 설정 고려.
* 모든 포트가 닫힌 것이 기본 설정이기 때문에 기본 설정 변경 필요.
* 기본 VPC, 기본 서브넷과 보안 그룹을 제공해서, 잘 모르면 기본 VPC 사용.

## 사용 절차

### 1. AWS에 로그인

* 리전 선택 > 관리 콘솔 접속 > VPC 대시보드 접속.

### 2. VPC 생성

* VPC 이름을 정함.
* CIDR 블록에 네트워크 범위 설정.
* 테넌시(하드웨어의 점유 여부)를 선택.

### 3. 서브넷 설정

* 서브넷 이름을 정함.
* 대상 VPC 선택.
* 가용 영역 선택.
* CIDR 블록(서브넷)을 설정.

### 4. 인터넷 연결

* 인터넷 게이트웨이를 생성.
* 인터넷 게이트웨이와 VPC를 연결.
* 라우팅 설정(라우팅 테이블을 생성하고 설정).

<br/>

# 기본 VPC

* 네트워크 지식이 없어도 이용할 수 있도록 리전별로 기본 VPC 제공.
* 특별한 설정 없이 바로 사용 가능.
* 특별한 요건이 없으면 기본 VPC 사용이 좋음.

## 기본 VPC의 구성

* 서브넷과 인터넷 게이트웨이가 기본적으로 구성되어 있음.
    * 인터넷이 필요 없으면 별도로 생성하거나 기본 VPC를 변경.
    * VPC 마법사로 쉽게 생성 가능.
* 네트워크 범위는 사설 IP 주소 172.31.0.0/16 부여.
* 기본 서브넷이라는 서브넷이 가용 영역별로 한 개씩 생성.

<br/>

# 서브넷과 DHCP

## 서브넷

* 커다란 네트워크를 작게 나눈 네트워크.
* 네트워크를 분할해서 직접 통신 범위 축소, 방화벽 설정을 통한 보안 강화.
* AWS는 어떤 가용 영역에 서브넷을 둘지 설정. 
    * AWS의 서브넷은 물리적인 장소를 특정.
* VPC는 사용 가능한 네트워크 범위 생성, 그 아래에 용도에 따라 서브넷 생성.
    * 서브넷 A는 공개, 서브넷 B는 비공개처럼 역할 부여 가능.
* 일반적으로 서브넷끼리 통신은 라우팅이 필요, VPC는 라우팅 없이 가능.

## 네트워크의 범위와 CIDR(Classless Inter-Domain Routing) 표기

* CIDR은 네트워크와 서브넷의 범위를 나누는 데 사용되는 표기법.
* 프리픽스 표기라고도 하며, /24 처럼 슬래시 뒤에 네트워크 길이 표시.
* CIDR은 IP의 주소 수를 나타냄.
    * /24는 256개, /20은 4,096개.
    * 2의 '32 - 네트워크 길이' 제곱.
* 네트워크 범위는 범위 안에서 가장 첫 번째 IP 주소와 CIDR 순으로 표기.
    * 172.31.0.0/16에서 /16은 65,536개로 172.31.0.0 ~ 172.31.255.255가 네트워크 범위.

## 네트워크 클래스

* 네트워크 규모에 따라 A, B, C 세 클래스 존재.

|클래스|CIDR|IP 주소 수|사설 IP 범위|
|---|---|---|---|
|A|/8 ~ /15|131,072 ~ 16,777,216|10.0.0.0 ~ 10.255.255.255|
|B|/16 ~ /23|512 ~ 65,536|172.16.0.0 ~ 172.31.255.255|
|C|/24 ~ /32|1 ~ 256|192.168.0.0 ~ 192.168.255.255|

* 기본 VPC는 B 클래스, /20으로 분할한 서브넷이 각 가용 영역에 구성.
* /20은 IP 주소 4,096개로 오토 스케일링에 충분.
* 서브넷은 /16 이하여야 하기 때문에 A 클래스는 서브넷 설정 불가.

## DHCP(Dynamic Host COnfiguration Protocol)

* DHCP는 사용할 수 있는 IP 주소 풀을 보유하면서, 클라이언트에게 자동으로 IP를 할당하는 서버.
* DHCP에서 각 호스트(인스턴스)에 IP 주소 자동 할당.
    * 인스턴스가 추가되면 해당 서브넷 범위의 IP 주소 중 하나가 할당.

## 예약 IP 주소

* 서브넷의 첫 번째 ~ 네 번쨰, 마지막 IP 주소는 AWS에 예약된 IP 주소.
* 실제 사용가능한 IP 주소가 256개라면 5개를 제외한 251개.

<br/>

# 라우팅과 NAT

## 네트워크와 라우팅

* 네트워크는 PC 여러 대가 서로 통신하도록 연결된 상태.
* 예전에는 1:1로 직접 선을 연결했었지만, 현재는 라우터를 통해 통신함.
* 라우터가 데이터를 목적지로 보내는 방식을 라우팅이라 함.
    * 호스트에서 호스트로 데이터를 전달하는 형태.

## 게이트웨이

* 데이터 전송시 목적지의 IP를 지정하고 라우터로 보냄.
* 라우터는 자신의 네트워크에 목적지가 있는지 확인해서 보내고 없으면 다른 라우터로 전송.
* 라우터에는 목적지로 가는 가장 빠른 경로가 저장되어 있음.
* 라우터는 네트워크의 관문에 위치해 있어서 게이트웨이라고도 함.
    * 게이트웨이는 기기의 역할을 의미, 실제 기기는 라우터.
* 게이트웨이 중에 자신 이외의 접속되어 있는 모든 것(보통 인터넷과의 연결점)을 기본 게이트웨이라고 함.

## IP 마스커레이드(masquerade)

* LAN 내부에서 인터넷 사용시, 게이트웨이가 LAN 내부 PC에 할당된 사설 IP를 공인 IP로 변환.
* LAN 내부의 PC들은 공인 IP 주소 하나를 공동으로 사용.
* 주소 변환을 담당하는 것이 IP 마스커레이드(NAPT(Network Address Port Translation)).
    * 포트를 포함한 사설 IP 주소를 공인 IP 주소로 변환.

## NAT(Network Address Translation)

* 마스커레이드는 내부에서 외부로 나가는건 가능하지만 외부에서 내부로 들어오는건 불가.
* LAN 내부의 서버는 외부 요청이 가능해야 하는데, IP 마스커레이드로 양방향 설정은 가능.
* 만약 서버가 여러 대면 NAT를 사용해야 함.
    * 마스커레이드는 공인 IP 하나만 설정, NAT는 여러개 설정 가능.
* 마스커레이드는 포트 변환 가능, NAT는 불가능.

<br/>

# 인터넷 게이트웨이와 NAT 게이트웨이

## 인터넷 게이트웨이

* 인터넷 연결을 담당.
* 외부에서 EC2 인스턴스에 있는 웹 서버로의 페이지 요청은 공인 IP를 이용.
* EC2는 사설 IP 주소만 할당 가능하므로 인터넷 게이트웨이가 공인 IP를 사설 IP로 변환.

## NAT 게이트웨이

* 사설망에서만 사용하는 서버의 소프트웨어 업데이트를 위해서 인터넷과 연결시에 사용.
* 서브넷에서 인터넷으로 접속 가능, 인터넷에서 서브넷으로 접속 불가.

<br/>

# 보안 그룹과 네트워크 ACL

* VPC의 가상 방화벽.
* 인바운드, 아웃바운드 트래픽을 제어.
* 반드시 양쪽 모두 설정, 설정이 없으면 기본 설정 적용.

## 특징

|항목|보안 그룹|네트워크 ACL|
|---|---|---| 
|설정 범위|인스턴스에 대해 설정.<br/>최대 5개 할당 가능.|서브넷에 설정.|
|규칙|규칙 허용만 가능.|규칙 허용과 거부 가능.|
|상태|스테이트풀(stateful)<br/>규칙과 상관없이 반환된 트래픽 자동 허용.|스테이트리스(stateless)<br/>반환된 트래픽 규칙에 따라 명시적 허용.|
|규칙의 적용 순서|모든 규칙을 확인해서 트래픽 허가 여부 결정.|순서대로 규칙 처리하면서 트래픽 허가 여부 결정.|

* 인스턴스에 보안 그룹 설정 없어도 네트워크 ACL로 처리 가능.
* 네트워크 ACL 하나로 여러 서브넷 설정 가능, 하나의 서브넷에 여러 네트워크 ACL 설정 불가.
* 네트워크 ACL이 설정된 서브넷에 새로운 설정 적용하면 덮어씀.

## 인바운 및 아웃바운드 설정

* 트래픽은 인바운드, 아웃바운드 각각에 대해 포트 단위로 허가 여부 설정.
* 보안 그룹은 아웃바운드만 허가, 네트워크 ACL은 양쪽 모두 허가하는 것이 기본 설정.
    * 이후 보안 그룹은 필요한 포트만 허가 설정.

<br/>

# VPC 엔드포인트

* VPC 내부에서 VPC 외부로 접속하기 위한 연결점을 제공.
    * AWS에는 VPC를 지원하지 않는 서비스도 있음. (대표적으로 S3, DynamoDB)
    * 이런 서비스들이 서로 접속하면서 연동할 때 필요.
* 엔드포인트가 없으면 인터넷 게이트웨이를 통해서 외부로 연결해야 함.
* VPC의 출입구로 엔드포인트를 설정하면 S3와 직접 연결 가능.
* 가상 서비스로 확장성과 고가용성 지원, 네트워크 트래픽에 대해 자동 스케일링 됨.

## 인터페이스 엔드포인트와 게이트웨이 엔드포인트

* 인터페이스 엔드포인트는 네트워크 인터페이스(ENI, Elastic Network Interface)로 구축.
    * 사설 IP 주소를 가진 ENI가 존재, 각 서비스와 연결하는 출입구 역할 수행.
    * AWS PrivateLink라는 방식을 사용.
* 게이트웨이 엔드포인트는 라우팅 테이블에 설정된 내용을 라우팅.
    * 서비스 리전 단위로 라우팅 테이블을 설정.
    * 한 번 설정하면 해당 리전의 모든 서비스에서 사용 가능.
    * S3와 DynamoDB가 이러한 형식임.

## 요금

* 무료지만 인터페이스 엔드포인트는 PrivateLink 사용에 대한 요금이 부과됨.
    * VPC 엔드포인트 한 개당 사용료(PrivateLink를 사용한 시간) + 데이터 처리량.
* 게이트웨이 엔트포인트는 EC2처럼 데이터 송신료가 부과됨.
