# 대규모 서비스를 지탱하는 기술

## 리눅스 단일 호스트의 부하

서버에 부하가 많아지면 서버를 여러대두어서 부하를 분산하려고 한다. 그런데 한 대의 서버가 감당할 수 있는 부하를 최대한으로 끌어 올린 상태에서 분산을 시도해야 효율적일 것이다. 그러기 위해서는 서버 리소스의 이용현황을 정확하게 파악해서 부하가 얼마나 걸리는지 알고, 병목이 되는 부분을 제거해야 한다. 그리고 더 이상 제거할 병목구간이 없다면 부하분산을 시도한다.

### Load Average(시스템 전체의 부하상황) 확인

시스템의 병목을 알아내기 위한 첫 번째 단계로, Load Average를 알아내야 한다. top이나 uptime 커맨드로 확인해서 이 지표가 너무 높지는 않은지 확인한다.

만약 이 지표가 낮은데 시스템의 전송량이 낮다면, 네트워크나 원격 호스트 등에 문제가 없는지 확인이 필요하다.

### CPU나 I/O의 병목 원인 조사

Load Average가 높다면 그 다음으로 병목의 구간이 CPU인지 I/O인지를 알아내야 한다. sar나 vmstat로 시간 경과에따라 CPU 사용율이나 I/O 대기율을 확인할 수 있다.

#### **CPU 부하가 높을 경우**

* 사용자 프로그램의 처리가 문제인지, 시스템 프로그램이 원인인지 확인. (top, sar 명령어)
* ps로 프로세스 상태나 CPU 사용시간 체크.
    * 병목이 되는 프로세스를 strace나 oprofile로 원인을 좁혀감.

만약 메모리나 디스크 등에서는 병목이 생기지 않는 이상적인 상태인데 시스템의 전송량에 문제가 있다면, 서버 증설 또는 프로그램의 로직이나 알고리즘을 개선한다.

#### **I/O 부하가 높을 경우**

프로그램으로부터 입출력이 많거나 스왑이 발생해서 디스크에 접근해야 하는 경우인데, sar나 vmstat로 스왑의 발생상황을 확인해서 어떤 문제인지 확인한다. 만약 스왑이 아닌 I/O가 빈번한 상황이라면, 캐시에 필요한 메모리가 부족한 경우일 수 있다.

* 스왑 발생.
    * 특정 프로세스가 극단적으로 메모리를 사용하지는 않는지 ps로 확인.
        * 프로그램의 오류로 메모리를 너무 많이 사용하지 않는지 확인.
    * 메모리가 부족하다면 메모리 증설, 증설할 수 없으면 분산 검토.
* 디스크 입출력이 많음.
    * 메모리 증설로 캐시영역 확대가 가능하다면 메모리 증설.
    * 메모리 증설로 대응이 불가능하다면 데이터 분산이나 캐시서버 도입 검토.
    * 프로그램을 개선해서 I/O를 줄일 수 있는지 검토.

## OS 튜닝이란

튜닝의 본래 의미는 병목이 발견되면 이것을 제거하는 작업이다. 본래의 소프트웨어나 하드웨어가 가지고있는 성능을 그 이상으로 끌어올리는 것이라고 착각할 수 있는데 그것이 아니다.

그럼 OS 튜닝이란 것은 부하의 원인을 알고 이것을 제거하는 것인데, 최근의 OS에서는 충분한 성능을 낼 수 있도록 기본설정이 되어 있다. 그래서 OS 설정을 변경해봐야 병목을 해결하는 것에는 크게 효과가 없다.

예를 들면, 고속도로에서 차가 밀리지 않는 상태에서 목적지까지 10초가 걸린다고 할 때, 고속도로의 차도를 넓힌다고 해서 목적지 도착까지의 시간이 10초 아래로 줄어들지는 않는것처럼 말이다.

하지만 I/O에서 병목이 생겨서 10초 걸릴 일을 100초로 늘어났다고 한다면, I/O 성능을 개선할 수는 있을 것이다.
결국, 부하 원인이 어디인지를 정확히 짚어낼 줄 알아야하고, 그것에 대한 대응방법을 적용하는것이 OS 튜닝이다.

# 회고

## 아쉬운 점

대규모 서비스를 지탱하는 기술이란 책을 읽으면서, OS나 컴퓨터 구조에 대한 지식의 부족함을 많이 느끼는 중이다. 대학시절에는 이 부분에 대해서 소홀하고 오히려 언어공부가 중요하다고 생각했었는데, 요즘은 언어보다도 이런 기초적인 지식을 탄탄하게 하는것이 중요하다는 것을 뼈저리게 느끼고 있다.

앞으로는 기초지식을 매일 30분씩이라도 꾸준히 공부해야겠다. 아무래도 양도 방대하고 한 번에 다 공부하려고하면 지칠것이 뻔하기때문에 매일 조금씩 공부를 하는것이 좋을것 같다. 이 부분을 탄탄하게 하지 않으면 앞으로 개발자로서 성장하는데 계속 걸림돌이 될 것 같다.