# 대규모 서비스를 지탱하는 기술

## OS 캐시

OS에서는 캐시를 이용해서 디스크에 액세스하는 것을 줄이고자 한다. 그리고 보통 페이지 캐시라는 캐시 구조를 사용하며, 가상 메모리 구조 기반에서 동작한다.

## 가상 메모리 구조

가상 메모리 구조는 물리적인 실제 메모리 주소를 OS에서 추상화한 가상의 메모리 주소로 변환하는 것을 말한다. 즉, 물리적인 하드웨어를 OS에서 추상화하는 것이다.

프로세스에서 메모리 공간이 필요하다고 OS에게 요청을 하면, OS는 메모리에서 비어 있는곳을 찾게 된다. 비어 있는 메모리 공간의 주소를 찾으면 OS는 해당 메모리 주소를 직접 프로세스로 전달하는것이 아니라 다른 주소값으로 변환해서 넘겨준다.

여기서 메모리 공간을 확보할 때는 1바이트씩 확보하는 것이 아니라, 4KB 정도를 블록으로 확보해서 프로세스로 넘겨준다. 이 블록을 '페이지'라고 하며, 프로세스로 메모리를 넘겨줄때는 1개 이상의 페이지를 넘겨준다.

## Linux 페이지 캐시 원리

OS는 확보한 페이지를 메모리상에 계속 남겨두는 전략을 이용한다.

### 디스크에서 데이터를 읽어와서 캐시하는 과정

1. 프로세스가 필요한 데이터를 디스크에서 4KB 블록의 페이지 단위로 읽어온다.
2. 읽어온 데이터를 메모리상에 위치시킨다.
3. 프로세스가 해당 메모리의 가상 메모리 주소를 전달받고, 접근해서 사용한다.
4. 프로세스의 데이터 읽기가 끝나도 메모리상에서 지우지않고 남겨둔다.
5. 이후에 다른 프로세스가 해당 데이터 접근이 필요할 때, 디스크에 다시 액세스하지 않고 메모리에 캐시해둔 해당 데이터를 사용한다.

### 페이지 캐시의 효과

OS의 페이지 캐시 전략으로 인해서, OS를 계속 가동시켜두면 둘수록 메모리에는 캐시된 데이터가 많아질 것이다. 그래서 재부팅하지 않고 OS를 계속 가동시켜두면 속도가 빨라지는 효과를 얻을 수 있다.

## VFS(Virtual File System, 가상 파일 시스템)

VFS는 여러 파일 시스템을 추상화 해놓은 추상화 레이어라고 할 수 있다. 파일 시스템(ext2, ext3, ext4 등)은 디스크를 실제로 조작하는 디스크 드라이버 위에 위치하며, 각 파일시스템은 각자 다양한 함수들을 보유하고 있다. 그리고 VFS는 이 파일 시스템 위에 존재한다.

VFS는 여러 파일 시스템들이 제공하는 함수를 하나의 인터페이스로 추상화시키고, 페이지 캐시 구조를 VFS가 지니고 있기 때문에 어떤 파일 시스템이더라도 동일하게 디스크를 읽고 페이지를 캐싱할 수 있다.